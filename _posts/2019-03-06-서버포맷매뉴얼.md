---
layout: post
title:  "서버 포맷 및 Ubuntu 재설치 & 필수패키지 설치"
date:   2019-03-06
excerpt: "Guide of formatting server and reinstalling packages"
tag:
- Ubuntu18.04
- format
- PyTorch
comments: true
---

# 서버 포맷 및 Ubuntu 재설치 & 필수패키지 설치

## ubuntu 재설치

1. `Erase disk and install ubuntu 18.04.2`와 비슷한 걸로 클릭해서 포맷 및 설치를 진행
2. 재설치 후 IP와 DNS를 수동설정한 후 네트워크 껐다 켬
3. 터미널을 실행한 후 `sudo apt install ssh openssh-server`를 하여 ssh접속을 위한 패키지 설치
4. `sudo ufw allow 22`와 `sudo ufw allow 2222`를 하여 port 22(로컬네트워크)와 2222로 접속 가능하게 함.
5. `sudo ufw enable`을 하여 앞서 설정한 포트로만 접속할 수 있게 방화벽을 실행한다.
6. `sudo vi /etc/ssh/sshd_config`를 하고 `#PORT 22`로 주석처리된 부분을 `PORT 2222`로 하여 ssh로 접속 시 port 2222로 접속 가능하게 함.
7. `sudo service ssh start`를 하여 ssh 서비스를 실행하고 `sudo reboot`을 하여 재부팅함.

## 필수 패키지 설치

이 부분부터는 원격으로 가능 (터미널에서 `ssh mlvc01@163.180.146.62 -p 2222`로 접속 가능)

1. 업데이트 및 설치된 패키지 업그레이드
```shell
sudo apt update && sudo apt upgrade -y
```

2. vim 등 기본 패키지 설치
```shell
sudo apt install -y vim git curl make cmake automake net-tools python-pip python3-pip
```

3. cuda 설치를 위한 key 설치
```shell
sudo apt-key adv --fetch-keys http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub
```

4. repo에 추가
```shell
sudo bash -c 'echo "deb http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64 /" > /etc/apt/sources.list.d/cuda.list'
```

5. 다시 apt update 실행
~~~shell
sudo apt update
~~~

6. xserver core 파일 설치 
```shell
sudo apt install -y xserver-xorg-core
```

7. nvidia driver 418버전 설치 (19.03.05 기준 cuda10.1과 호환)
```shell
sudo apt install nvidia-driver-418
```

8. cuda 10.1 설치 (19.03.05 기준 driver 418버전과 호환)
```shell
sudo apt install cuda
```
또는
```shell
sudo apt install cuda-10-1
```

9. CUDA PATH 환경변수 설정을 위해 `~/.profile`파일의 마지막 부분에 아래 라인 추가 (`vi ~/.profile`)
```
# set PATH for CUDA installation
if [ -d "/usr/local/cuda/bin/" ]; then
    export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
fi
```

10. `/etc/environment`에 따옴표(`'`)안에 `:/usr/local/cuda/bin` 추가 (`sudo vi /etc/environment`)
```
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/local/cuda/bin"
```

11. 설치 완료를 위해 reboot
```shell
sudo reboot
```

12. CUDA설치 확인을 위해 nvcc(NVIDIA CUDA Compiler)의 버전 확인 (`nvcc --version`)

```
mlvc02@mlvc02:~$ nvcc --version
nvcc: NVIDIA (R) Cuda compiler driver
Copyright (c) 2005-2019 NVIDIA Corporation
Built on Fri_Feb__8_19:08:17_PST_2019
Cuda compilation tools, release 10.1, V10.1.105
```

13. nvidia 드라이버 설치 확인 (`nvidia-smi`)

```
mlvc02@mlvc02:~$ nvidia-smi
Tue Mar  5 19:29:32 2019       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 418.39       Driver Version: 418.39       CUDA Version: 10.1     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  GeForce GTX 108...  On   | 00000000:19:00.0 Off |                  N/A |
| 33%   28C    P8    15W / 250W |      2MiB / 11178MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
|   1  GeForce GTX 108...  On   | 00000000:1A:00.0 Off |                  N/A |
| 33%   32C    P8    15W / 250W |      2MiB / 11178MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
|   2  GeForce GTX 108...  On   | 00000000:67:00.0 Off |                  N/A |
| 33%   29C    P8    15W / 250W |      2MiB / 11178MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
|   3  GeForce GTX 108...  On   | 00000000:68:00.0 Off |                  N/A |
| 33%   28C    P8    16W / 250W |     18MiB / 11176MiB |      0%      Default |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|    3      1248      G   /usr/lib/xorg/Xorg                             9MiB |
|    3      1361      G   /usr/bin/gnome-shell                           6MiB |
+-----------------------------------------------------------------------------+
```

## PyTorch 1.0.1 설치

__모든 단계는 python2버전과 3버전 모두 실행함.__

1. PyPI(Python Package Index) 업데이트 (python2와 python3버전 모두 업데이트)
```shell
sudo -H pip install -U pip
sudo -H pip3 install -U pip
```

__위 단계를 진행하면 pip가 pip3와 같아지므로 이제 python2버전은 pip2로 실행해야 함.__  
__따라서 앞으로 업데이트할 때도 pip2 먼저 실행해야 그대로 pip가 pip3에 링크됨.__

2. PyTorch 설치
```shell
sudo -H pip install https://download.pytorch.org/whl/cu100/torch-1.0.1.post2-cp36-cp36m-linux_x86_64.whl
sudo -H pip2 install https://download.pytorch.org/whl/cu100/torch-1.0.1.post2-cp27-cp27mu-linux_x86_64.whl
```

3. TorchVision 설치
```shell
sudo -H pip install torchvision
sudo -H pip2 install torchvision
```

## 기타 python 패키지 설치

1. tk-inter 설치
```shell
sudo apt install python-tk python3-tk
```

2. 기타 머신러닝, 딥러닝 등 많이 쓰이는 패키지 설치
```shell
sudo -H pip install dlib tqdm opencv-python numpy cvxpy scipy scikit-learn scikit-image matplotlib virtualenv
sudo -H pip2 install dlib tqdm opencv-python numpy cvxpy scipy scikit-learn scikit-image matplotlib virtualenv
```

## Docker 설치

[Docker 설치 방법](https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-using-the-repository) 참고  
아래 설치방법은 19.03.06 기준. 나중에 바뀔 수 있으니 위 링크 참조

### SET UP THE REPOSITORY

1. Update the `apt` package index:
```shell
sudo apt update
```

2. Install packages to allow `apt` to use a repository over HTTPS:
```shell
sudo apt-get install apt-transport-https ca-certificates gnupg-agent software-properties-common
```

3. Add Docker's official GPG key:
```shell
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

4. Use the following command to set up the __stable__ repository.
```shell
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
```

### INSTALL DOCKER CE

1. Update the `apt` package index:
```shell
sudo apt update
```

2. Install the latest version of Docker CE and containerd
```shell
sudo apt install docker-ce docker-ce-cli containerd.io
```

## NVIDIA-DOCKER2 설치

[NVIDIA-Docker 설치 방법](https://github.com/NVIDIA/nvidia-docker#quickstart) 참고  
아래 설치방법은 19.03.06 기준. 나중에 바뀔 수 있으니 위 링크 참조

### Add the package repositories

1. Add NVIDIA-Docker's official GPG key:
```shell
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
```

2. Set Distribution
```shell
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
```

3. Use the following command to set up the repository.
```shell
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
```

### Install nvidia-docker2 and reload the Docker daemon configuration

1. Update the `apt` package index:
```shell
sudo apt update
```

2. Install the latest version of nvidia-docker2
```shell
sudo apt install -y nvidia-docker2
```

3. Reload the Docker daemon configuration
```shell
sudo pkill -SIGHUP dockerd
```

### Test nvidia-smi with the latest official CUDA image

```shell
docker run --runtime=nvidia --rm nvidia/cuda:9.0-base nvidia-smi
```

## 설치 후 세팅

### 1. Xorg 끄기 - 멀티유저세팅을 기본값으로 설정
```shell
sudo systemctl set-default multi-user.target
```

### 2. vim 세팅

1. vim colorscheme 다운로드
```shell
mkdir -p ~/.vim/colors
cd ~/.vim/colors
curl -O https://raw.githubusercontent.com/nanotech/jellybeans.vim/master/colors/jellybeans.vim
curl -O https://raw.githubusercontent.com/tomasr/molokai/master/colors/molokai.vim
```

2. vimrc 세팅

>`vi ~/.vimrc`로 열어서 `i`눌러서 입력모드로 바꾼 후 복붙  
> 복붙하면 `set backspace`부터 주석 생기는데 아래 보면서 주석 다 지워야 함.

```
set hlsearch
set nu
set autoindent      " copy indent from current line when starting a new line
set scrolloff=2
set wildmode=longest,list
set ts=4    "tag select
set sts=4   "st select
set sw=1
set autowrite
set autoread
set cindent         " C auto indent
set history=256
set laststatus=2
set shiftwidth=4    " number of spaces to use for auto indent
set expandtab       " enter spaces when tab is pressed
set showmatch
set smartcase
set smarttab
set smartindent
set softtabstop=4
set tabstop=4       " use 4 spaces to represent tab
set ruler           " show cursor location
" make backspaces more powerful
set backspace=indent,eol,start

set incsearch
set statusline=\ %<%l:%v\ [%P]%=%a\ %h%m%r\ %F\

" place cursor to last modified
au BufReadPost *
\ if line("'\"") > 0 && line("'\"") <= line("$") |
\ exe "norm g`\"" |
\ endif

" file enconding to korean
if $LANG[0]=='k' && $LANG[1]=='o'
set fileencoding=korea
endif

" syntax highlighting
if has("syntax")
    syntax on
endif

" using colorscheme
colorscheme molokai
" colorscheme jellybeans
```

### 3. zsh설치

1. zsh 설치
```shell
sudo apt install zsh
```

2. 기본 셸을 zsh로 바꾸기
```shell
chsh -s `which zsh`
```

3. Oh My ZSH 설치
```shell
sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
```

4. zsh plugin 설치
```shell
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
git clone https://github.com/djui/alias-tips.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/alias-tips
```

5. zshrc 세팅

> `vi ~/.zshrc`로 열어서 복붙  
> 아래 나와있는 부분에서 다른부분 보고 바꾸기  
> 여기도 복붙하면 주석과 띄어쓰기가 아래와 다르게 더 들어가므로 똑같이 되도록 빈칸과 주석 delete 잘 해주면 됨.

```
# If you come from bash you might have to change your $PATH.
# export PATH=$HOME/bin:/usr/local/bin:$PATH

# Path to your oh-my-zsh installation.
  export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load --- if set to "random", it will
# load a random theme each time oh-my-zsh is loaded, in which case,
# to know which specific one was loaded, run: echo $RANDOM_THEME
# See https://github.com/robbyrussell/oh-my-zsh/wiki/Themes
ZSH_THEME="agnoster"
```
~~  
~~  
~~  
```
# Add wisely, as too many plugins slow down shell startup.
plugins=(
  git apt pip alias-tips
  zsh-syntax-highlighting
  zsh-autosuggestions
)

source $ZSH/oh-my-zsh.sh

# User configuration
prompt_context() {
  if [[ "$USER" != "$DEFAULT_USER" || -n "$SSH_CLIENT" ]]; then
    prompt_segment black default "%(!.%{%F{yellow}%}.)$USER"
  fi
}
```
~~  
~~  
~~  
```
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"

# User alias
alias mlvc01ssh='ssh mlvc01@163.180.146.62 -p 2222'
alias mlvc02ssh='ssh mlvc02@163.180.146.63 -p 2222'
alias mlvc03ssh='ssh mlvc03@163.180.146.64 -p 2222'
alias mlvc04ssh='ssh mlvc04@163.180.146.65 -p 2222'
alias mlvc05ssh='ssh mlvc05@163.180.146.66 -p 2222'
alias mlvc06ssh='ssh mlvc06@163.180.146.71 -p 2222'
```

4. 설정되도록 `source`함.
```shell
source ~/.zshrc
```

### 4. mlvcgpu 계정 추가

1. skel 다운로드
```shell
git clone https://github.com/2KangHo/skel.git
```

2. skel 폴더에 복사 후 받은 폴더 삭제
```shell
cd skel
rm -rf .git
sudo mv .* /etc/skel/
cd ..
rm -rf skel
```

3. mlvcgpu 계정 추가 (`sudo adduser mlvcgpu`로 추가)
```shell
mlvc01@mlvc01:~$ sudo adduser mlvcgpu
Adding user `mlvcgpu' ...
Adding new group `mlvcgpu' (1001) ...
Adding new user `mlvcgpu' (1001) with group `mlvcgpu' ...
Creating home directory `/home/mlvcgpu' ...
Copying files from `/etc/skel' ...
Enter new UNIX password: 
Retype new UNIX password: 
passwd: password updated successfully
Changing the user information for mlvcgpu
Enter the new value, or press ENTER for the default
        Full Name []: mlvcgpu
        Room Number []: 
        Work Phone []: 
        Home Phone []: 
        Other []: 
Is the information correct? [Y/n] y
```

### 5. docker 유저에게 sudo없이 실행가능하도록 설정
```shell
sudo usermod -aG docker $USER
```
```shell
sudo usermod -aG docker mlvcgpu
```

### 6. 모든 설정 안전하게 되었는지 확인을 위해 리부팅

```shell
sudo reboot
```
